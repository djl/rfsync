#!/usr/bin/env python
"""
Usage: scully [<backup>]
"""
import os
import subprocess
import sys

try:
    import configparser
except ImportError:
    import ConfigParser as configparser


FILE = '~/.scully'


def error(msg, exitcode=1):
    """
    Print ``msg`` to stderr and exit with ``exitcode``.
    """
    msg = os.path.basename(sys.argv[0]) + ': ' + msg
    sys.stderr.write(msg + '\n')
    sys.exit(exitcode)


def expand(fn):
    """
    Fully expand a path, preserving trailing slashes
    """
    slash = fn[-1] == '/'
    fn = os.path.expandvars(fn)
    fn = os.path.expanduser(fn)
    fn = os.path.abspath(fn)
    if slash and fn[-1] != '/':
        fn += '/'
    return fn


class Backup(object):

    REQUIRED_OPTIONS = ['src', 'dest']

    def __init__(self, name, config, dry_run=False):
        self.name = name
        self.config = config
        self.dry_run = dry_run

        self.validate_options()
        self.validate_exclude()
        self.validate_src()
        self.validate_dest()

    def _expand_paths(self, paths):
        return [expand(p.strip()) for p in paths]

    def validate_exclude(self):
        if self.config.has_option(self.name, 'exclude'):
            self.exclude = [x.strip() for x in self.config.get(self.name, 'exclude').split(',')]
        else:
            self.exclude = []

    def validate_options(self):
        for option in self.REQUIRED_OPTIONS:
            if not self.config.has_option(self.name, option):
                error("Backup '%s' missing required option '%s'." % (self.name, option))

    def validate_src(self):
        src = self.config.get(self.name, 'src')
        self.src = [expand(x.strip()) for x in src.split(',')]

    def validate_dest(self):
        self.dest = expand(self.config.get(self.name, 'dest'))

    def run(self):
        # check if dest is required
        try:
            rdst = self.config.getboolean(self.name, 'require_dest')
            if rdst and not os.path.isdir(self.dest):
                error('Destination directory "%s" not found.' % self.dest)
        except configparser.NoOptionError:
            pass

        cmds = ['rsync', '-a', '-v', '-z']

        # delete files?
        try:
            if self.config.getboolean(self.name, 'delete'):
                cmds.append('--delete')
        except configparser.NoOptionError:
            pass

        if self.dry_run:
            cmds.append('--dry-run')

        cmds += self.src

        for exclude in self.exclude:
            cmds += ['--exclude', exclude]

        cmds.append(expand(self.dest))

        proc = subprocess.Popen(cmds)
        proc.communicate()


def main():
    config = configparser.ConfigParser()

    try:
        config.readfp(open(expand(FILE)))
    except IOError:
        error("Couldn't read your config file.")

    # list all backups
    if len(sys.argv) == 1:
        sys.stdout.write('\n'.join(sorted(config.sections())) + '\n')
        sys.exit(0)

    # are we doing a dry run?
    if sys.argv[1] in ['-n', '--dry-run']:
        dry_run = True
        del sys.argv[1]
    else:
        dry_run = False

    # does the backup exist?
    if not config.has_section(sys.argv[1]):
        error("Invalid backup '%s'." % sys.argv[1])


    # backup is good. let's do it
    backup = Backup(sys.argv[1], config, dry_run)
    backup.run()


if __name__ == '__main__':
    main()
