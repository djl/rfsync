#!/bin/bash
# Usage: scully [RSYNCOPTS] [<backup>]
PROGNAME="$(basename $0)"
BACKUP_DIR="$HOME/.scully"

abort() {
  echo "$PROGNAME: $1" >&2
  exit 1
}

if [ $# -eq 0 ]; then
  find "$BACKUP_DIR" -type f | xargs basename
  exit 0
fi

BACKUP="${!#}"

if [ ! -f "$BACKUP_DIR/$BACKUP" ]; then
  abort "Unknown backup '$BACKUP'"
fi

source "$BACKUP_DIR/$BACKUP" > /dev/null 2>&1

if [ -n "$SCULLY_REQUIRE_DEST" -a ! -d "$SCULLY_DEST" ]; then
  abort "Destination directory '$SCULLY_DEST' not found."
fi

exclude=$(printf " --exclude %s" "${SCULLY_EXCLUDE[@]}")

rsync -a ${@:1:$#-1} ${exclude[@]} ${SCULLY_SRC[@]} $SCULLY_DEST
